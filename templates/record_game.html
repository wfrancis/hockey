{% extends "base.html" %}

{% block title %}Record Game Stats - Hockey Stats{% endblock %}

{% block extra_style %}
<style>
  .stat-toggles {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0 5px;
    color: #4a5568;
    font-weight: 600;
  }
  .stat-toggles label { display: inline-flex; align-items: center; gap: 6px; }
  .stat-disabled { opacity: 0.5; pointer-events: none; }

  /* Mobile responsive design */
  @media (max-width: 768px) {
    /* Hide desktop table */
    .desktop-table {
      display: none;
    }
    
    /* Show mobile layout */
    .mobile-layout {
      display: block;
    }
    
    /* Premium mobile player cards */
    .mobile-player-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
      border: none;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.08);
      transition: all 0.2s ease;
    }
    
    .mobile-player-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.12);
    }
    
    .mobile-player-header {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }
    
    .mobile-player-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      margin-right: 12px;
      min-width: 48px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .mobile-player-name {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      letter-spacing: -0.5px;
    }
    
    .mobile-stats {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .mobile-stat {
      text-align: center;
      padding: 16px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      touch-action: pan-y; /* allow vertical scroll while capturing horizontal swipes */
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* Full-bleed stat tile (edge-to-edge inside card) */
    .mobile-stat.full-bleed {
      margin-left: -20px;  /* matches .mobile-player-card padding */
      margin-right: -20px; /* matches .mobile-player-card padding */
      border-radius: 0;
      border-left: none;
      border-right: none;
      padding: 0;
      overflow: hidden;
      border: none;
      box-shadow: none;
    }
    .mobile-stat.full-bleed .mobile-stat-controls {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      padding: 0;
    }
    .mobile-stat.full-bleed .mobile-btn {
      width: 100%;
      height: 64px;
      border-radius: 0;
      box-shadow: none;
    }
    .mobile-stat.full-bleed .mobile-stat-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      min-width: 72px;
      height: 44px;
      padding: 0 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      margin: 0;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #eceff3;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      pointer-events: none;
    }
    
    .mobile-stat:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(102, 126, 234, 0.2);
    }
    
    .mobile-stat-label {
      font-size: 10px;
      color: #667eea;
      margin-bottom: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .mobile-stat-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .mobile-btn {
      width: 60px;
      height: 60px;
      border: none;
      border-radius: 16px;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .mobile-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .mobile-btn:active::before {
      opacity: 1;
    }
    
    .mobile-btn.minus {
      background: linear-gradient(135deg, #ff6b6b 0%, #e53e3e 100%);
      color: white;
    }
    
    .mobile-btn.minus:hover {
      background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
    }
    
    .mobile-btn.plus {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color: white;
    }
    
    .mobile-btn.plus:hover {
      background: linear-gradient(135deg, #40c057 0%, #2f9e44 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(55, 178, 77, 0.3);
    }
    
    .mobile-btn:active {
      transform: translateY(0px) scale(0.95);
    }
    
    .mobile-stat-display {
      min-width: 44px;
      text-align: center;
      font-size: 24px;
      font-weight: 800;
      padding: 8px 12px;
      background: white;
      border-radius: 12px;
      border: 2px solid #f1f3f4;
      color: #2d3748;
      transition: all 0.2s ease;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .mobile-stat-display.positive {
      color: #37b24d;
      border-color: #c3fac8;
      background: linear-gradient(135deg, #ffffff 0%, #f3f9f3 100%);
    }
    
    .mobile-stat-display.negative {
      color: #e53e3e;
      border-color: #ffc9c9;
      background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
    }
    
    /* Micro-interactions for value change */
    @keyframes bump {
      0% { transform: scale(1); }
      35% { transform: scale(1.12); }
      100% { transform: scale(1); }
    }
    .mobile-stat-display.bump {
      animation: bump 180ms ease;
    }
    
    /* Mobile forms and typography */
    h2 {
      font-size: 1.4em !important;
      margin-bottom: 20px !important;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }
    
    h3 {
      font-size: 1.2em !important;
      margin-bottom: 16px !important;
      color: #4a5568;
      font-weight: 700;
    }
    
    /* Enhanced form controls */
    input[type="datetime-local"], input[type="text"] {
      padding: 14px 16px !important;
      border: 2px solid #e2e8f0 !important;
      border-radius: 12px !important;
      font-size: 16px !important;
      background: white !important;
      transition: all 0.2s ease !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }
    
    input[type="datetime-local"]:focus, input[type="text"]:focus {
      border-color: #667eea !important;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      outline: none !important;
    }
    
    /* Premium checkboxes */
    .checkbox-container {
      background: rgba(255, 255, 255, 0.8);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.1);
      margin: 8px 0;
      transition: all 0.2s ease;
    }
    
    .checkbox-container:hover {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.2);
    }
    
    input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      margin-right: 10px !important;
      accent-color: #667eea !important;
    }
    
    label {
      font-weight: 600 !important;
      color: #4a5568 !important;
      font-size: 14px !important;
    }
    
    /* Enhanced action buttons */
    .btn {
      padding: 14px 24px !important;
      border-radius: 12px !important;
      font-weight: 700 !important;
      font-size: 16px !important;
      border: none !important;
      cursor: pointer !important;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #718096 0%, #4a5568 100%) !important;
      color: white !important;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 16px rgba(74, 85, 104, 0.3) !important;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
      color: white !important;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 16px rgba(72, 187, 120, 0.3) !important;
    }
    
    .btn:active {
      transform: translateY(0px) scale(0.98) !important;
    }
    
    /* Mobile autosave indicator */
    #autosaveStatus {
      padding: 8px 16px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      font-weight: 600 !important;
      margin: 12px 0 !important;
      border: none !important;
      backdrop-filter: blur(10px) !important;
    }
    
    /* Enhanced summary styling */
    #playersSummary {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%) !important;
      border: 2px solid rgba(102, 126, 234, 0.1) !important;
      border-radius: 16px !important;
      padding: 20px !important;
      margin: 24px 0 !important;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace !important;
      font-size: 13px !important;
      line-height: 1.6 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05) !important;
    }
    
    /* Smooth page transitions */
    .mobile-layout {
      animation: fadeInUp 0.4s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Enhanced container padding */
    .container {
      padding: 0 16px !important;
    }
    
    .form-group input {
      font-size: 16px; /* Prevent zoom on iOS */
      padding: 12px;
    }
    
    .stat-toggles {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .stat-toggles label {
      font-size: 12px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    
    /* Mobile summary and controls */
    #players-summary {
      font-size: 12px !important;
      line-height: 1.3 !important;
      margin-top: 16px !important;
      padding: 12px !important;
      background: #f8f9fa !important;
      border-radius: 6px !important;
    }
    
    #autosave-status {
      font-size: 11px !important;
      margin-top: 8px !important;
      text-align: center;
    }
    
    .btn {
      padding: 12px 20px !important;
      font-size: 14px !important;
      margin: 6px 4px !important;
      width: auto !important;
    }
  }
  
  /* Desktop styles */
  @media (min-width: 769px) {
    .desktop-table {
      display: table;
    }
    
    .mobile-layout {
      display: none;
    }
  }

  /* Simple modal popup for save confirmation */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-box {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 20px;
    color: #111827;
    font-weight: 700;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    min-width: 220px;
    text-align: center;
  }
</style>
{% endblock %}

{% block content %}
<h2 style="color: #2d3748; margin-bottom: 20px;">Record Game Statistics</h2>

<div id="alert-container"></div>

<form id="game-stats-form">
    <div class="form-group">
        <label for="game-date">Game Date & Time:</label>
        <input type="datetime-local" id="game-date" name="game_date" required>
    </div>
    <div class="form-group">
        <label for="game-name">Game Name (optional):</label>
        <input type="text" id="game-name" name="game_name" placeholder="e.g., vs Sharks (League), Scrimmage, Practice">
    </div>

    <h3 style="color: #4a5568; margin: 30px 0 20px;">Player Statistics</h3>

    <!-- Desktop Table Layout -->
    <table class="desktop-table">
        <thead>
            <tr>
                <th>Player</th>
                <th style="text-align: center;">Plus/Minus (+/-)</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td>
                    <span class="player-number">#{{ player.number }}</span>
                    <strong>{{ player.name }}</strong>
                    <input type="hidden" id="player_id_{{ loop.index0 }}" value="{{ player.id }}">
                </td>
                <td>
                    <div class="stat-input-group">
                        <button type="button" class="stat-btn stat-btn-minus" onclick="updateStat({{ loop.index0 }}, 'plus_minus', -1)">−</button>
                        <div class="stat-display" id="plus_minus_{{ loop.index0 }}">0</div>
                        <button type="button" class="stat-btn stat-btn-plus" onclick="updateStat({{ loop.index0 }}, 'plus_minus', 1)">+</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Mobile Layout -->
    <div class="mobile-layout">
        {% for player in players %}
        <div class="mobile-player-card">
            <div class="mobile-player-header">
                <div class="mobile-player-number">#{{ player.number }}</div>
                <div class="mobile-player-name">{{ player.name }}</div>
                <input type="hidden" id="player_id_mobile_{{ loop.index0 }}" value="{{ player.id }}">
            </div>
            
            <div class="mobile-stats">
                <!-- Plus/Minus -->
                <div class="mobile-stat-label">+/-</div>
                <div class="mobile-stat full-bleed" data-player-index="{{ loop.index0 }}" data-stat="plus_minus">
                    <div class="mobile-stat-controls">
                        <button type="button" class="mobile-btn minus" aria-label="Decrease +/-" onclick="updateStat({{ loop.index0 }}, 'plus_minus', -1)">−</button>
                        <div class="mobile-stat-display" id="plus_minus_mobile_{{ loop.index0 }}">0</div>
                        <button type="button" class="mobile-btn plus" aria-label="Increase +/-" onclick="updateStat({{ loop.index0 }}, 'plus_minus', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="players-summary" style="margin-top: 16px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 14px; color: #4a5568;"></div>
    <div id="autosave-status" style="margin-top: 8px; font-size: 12px; color: #718096;">Autosave off. Press Save to enable.</div>

    <div style="margin-top: 30px; text-align: center;">
        <button type="button" class="btn" style="margin-right: 10px; background: #718096;" onclick="resetAllStats()">Reset All</button>
        <button type="submit" class="btn btn-success" style="font-size: 18px; padding: 15px 40px;">Save Game Stats</button>
    </div>
</form>

<!-- Save confirmation modal -->
<div id="save-modal" class="modal-backdrop" style="display:none;">
  <div class="modal-box">Game saved!</div>
  </div>

<script>
// Store stats in memory
const playerStats = {};
const playerCount = {{ players|length }};
const playerMeta = [
    {% for player in players %}
    { number: {{ player.number }}, name: {{ player.name|tojson }} }{% if not loop.last %}, {% endif %}
    {% endfor %}
];

// Autosave state
let autosaveTimer = null;
let autosaveEnabled = false; // Enable after first manual save
const AUTOSAVE_DELAY = 500; // ms
const autosaveStatusEl = document.getElementById('autosave-status');
function setAutosaveStatus(text, ok = true) {
    // Update desktop autosave status
    if (autosaveStatusEl) {
        autosaveStatusEl.textContent = text;
        autosaveStatusEl.style.color = ok ? '#718096' : '#e53e3e';
    }
    
    // Update mobile autosave status
    const mobileAutosave = document.getElementById('mobileAutosave');
    if (mobileAutosave) {
        mobileAutosave.textContent = text;
        mobileAutosave.style.color = ok ? '#28a745' : '#dc3545';
    }
}

function buildPayload(isAutosave = false) {
    const gameDate = document.getElementById('game-date').value;
    const gameName = (document.getElementById('game-name').value || '').trim();
    // Inverted logic: checked = enabled; unchecked = N/A (disabled)
    const na = {
        plus_minus: !(document.getElementById('na_plus_minus')?.checked ?? true)
    };

    const players = [];
    for (let i = 0; i < playerCount; i++) {
        players.push({
            player_id: parseInt(document.getElementById(`player_id_${i}`).value),
            plus_minus: na.plus_minus ? 0 : playerStats[i].plus_minus
        });
    }
    return { game_date: gameDate, game_name: gameName, players, autosave: isAutosave };
}

function autosaveSchedule() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    setAutosaveStatus('Saving...');
    autosaveTimer = setTimeout(autosaveNow, AUTOSAVE_DELAY);
}

async function autosaveNow() {
    try {
        const payload = buildPayload(true);
        const response = await fetch('/save_game_stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
            const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            setAutosaveStatus(`Saved ${ts}`);
        } else {
            setAutosaveStatus(`Autosave failed: ${result.message}`, false);
        }
    } catch (err) {
        setAutosaveStatus('Autosave error', false);
        console.error('Autosave error:', err);
    }
}

// Initialize stats for each player - use existing stats if available
const existingStatsData = {{ existing_stats|tojson }};
for (let i = 0; i < playerCount; i++) {
    const playerId = parseInt(document.getElementById(`player_id_${i}`).value);
    const existingPlayerStats = existingStatsData[playerId] || {};
    
    playerStats[i] = {
        plus_minus: existingPlayerStats.plus_minus || 0
    };
    
    // Update display elements with existing values
    const value = playerStats[i].plus_minus;
    
    // Update desktop display
    const desktopDisplay = document.getElementById(`plus_minus_${i}`);
    if (desktopDisplay) {
        if (value > 0) {
            desktopDisplay.textContent = `+${value}`;
            desktopDisplay.classList.add('positive');
        } else if (value < 0) {
            desktopDisplay.textContent = value;
            desktopDisplay.classList.add('negative');
        } else {
            desktopDisplay.textContent = '0';
        }
    }
    
    // Update mobile display
    const mobileDisplay = document.getElementById(`plus_minus_mobile_${i}`);
    if (mobileDisplay) {
        if (value > 0) {
            mobileDisplay.textContent = `+${value}`;
            mobileDisplay.classList.add('positive');
        } else if (value < 0) {
            mobileDisplay.textContent = value;
            mobileDisplay.classList.add('negative');
        } else {
            mobileDisplay.textContent = '0';
        }
    }
}

// Initialize totals and summary on load
updateTotals();
renderPlayersSummary();

function updateStat(playerIndex, statType, increment) {
    // Update the value
    playerStats[playerIndex][statType] += increment;

    // Prevent negative values for shots, blocked shots, and takeaways
    if (statType !== 'plus_minus' && playerStats[playerIndex][statType] < 0) {
        playerStats[playerIndex][statType] = 0;
    }

    const value = playerStats[playerIndex][statType];

    // Update desktop display
    const display = document.getElementById(`${statType}_${playerIndex}`);
    if (display) {
        // Update text
        if (statType === 'plus_minus' && value > 0) {
            display.textContent = `+${value}`;
        } else {
            display.textContent = value;
        }

        // Update color for plus/minus
        if (statType === 'plus_minus') {
            display.classList.remove('positive', 'negative');
            if (value > 0) {
                display.classList.add('positive');
            } else if (value < 0) {
                display.classList.add('negative');
            }
        }
    }

    // Update mobile display
    const mobileDisplay = document.getElementById(`${statType}_mobile_${playerIndex}`);
    if (mobileDisplay) {
        // Update text
        if (statType === 'plus_minus' && value > 0) {
            mobileDisplay.textContent = `+${value}`;
        } else {
            mobileDisplay.textContent = value;
        }

        // Update color for plus/minus
        if (statType === 'plus_minus') {
            mobileDisplay.classList.remove('positive', 'negative');
            if (value > 0) {
                mobileDisplay.classList.add('positive');
            } else if (value < 0) {
                mobileDisplay.classList.add('negative');
            }
        }
    }

    // Update totals and summary after any change
    updateTotals();
    renderPlayersSummary();
    if (autosaveEnabled) autosaveSchedule();
}

// Compute and render a plain-text summary for each player
function renderPlayersSummary() {
    const lines = [];
    for (let i = 0; i < playerCount; i++) {
        const meta = playerMeta[i];
        const s = playerStats[i];
        const pmText = s.plus_minus > 0 ? `+${s.plus_minus}` : `${s.plus_minus}`;
        lines.push(`#${meta.number} ${meta.name}: +/- ${pmText}`);
    }
    const container = document.getElementById('players-summary');
    if (container) container.textContent = lines.join('\n');
}

// Compute and render totals across all players
function updateTotals() {
    const totals = { plus_minus: 0 };
    for (let i = 0; i < playerCount; i++) {
        totals.plus_minus += playerStats[i].plus_minus;
    }

    const pmDisplay = document.getElementById('total_plus_minus');
    if (pmDisplay) {
        pmDisplay.textContent = totals.plus_minus > 0 ? `+${totals.plus_minus}` : `${totals.plus_minus}`;
        pmDisplay.classList.remove('positive', 'negative');
        if (totals.plus_minus > 0) pmDisplay.classList.add('positive');
        else if (totals.plus_minus < 0) pmDisplay.classList.add('negative');
    }
}

function resetAllStats() {
    if (!confirm('Are you sure you want to reset all stats for this game?')) {
        return;
    }

    for (let i = 0; i < playerCount; i++) {
        playerStats[i] = {
            plus_minus: 0
        };

        // Update desktop display
        const desktopPM = document.getElementById(`plus_minus_${i}`);
        if (desktopPM) {
            desktopPM.textContent = '0';
            desktopPM.classList.remove('positive', 'negative');
        }

        // Update mobile display
        const mobilePM = document.getElementById(`plus_minus_mobile_${i}`);
        if (mobilePM) {
            mobilePM.textContent = '0';
            mobilePM.classList.remove('positive', 'negative');
        }
    }

    // Reset totals and summary as well
    updateTotals();
    renderPlayersSummary();
    if (autosaveEnabled) autosaveSchedule();
}

// Enable/disable stat columns globally via N/A checkboxes
function disableStatColumn(statType, isNA) {
    for (let i = 0; i < playerCount; i++) {
        // Handle desktop layout
        const display = document.getElementById(`${statType}_${i}`);
        if (display) {
            const group = display.parentElement; // .stat-input-group
            const buttons = group.querySelectorAll('button.stat-btn');
            if (isNA) {
                group.classList.add('stat-disabled');
            } else {
                group.classList.remove('stat-disabled');
            }
            buttons.forEach(btn => btn.disabled = isNA);
        }

        // Handle mobile layout
        const mobileDisplay = document.getElementById(`${statType}_mobile_${i}`);
        if (mobileDisplay) {
            const mobileControls = mobileDisplay.parentElement; // .mobile-stat-controls
            const mobileCard = mobileControls.closest('.mobile-stat');
            const mobileButtons = mobileControls.querySelectorAll('button.mobile-btn');
            if (isNA) {
                mobileControls.classList.add('stat-disabled');
                if (mobileCard) mobileCard.classList.add('stat-disabled');
            } else {
                mobileControls.classList.remove('stat-disabled');
                if (mobileCard) mobileCard.classList.remove('stat-disabled');
            }
            mobileButtons.forEach(btn => btn.disabled = isNA);
        }
    }
}

['plus_minus'].forEach(stat => {
    const cb = document.getElementById(`na_${stat}`);
    if (cb) cb.addEventListener('change', (e) => { 
        // unchecked => disabled (N/A)
        disableStatColumn(stat, !e.target.checked); 
        if (autosaveEnabled) autosaveSchedule();
    });
});

// Autosave when game date changes
document.getElementById('game-date').addEventListener('change', () => { if (autosaveEnabled) autosaveSchedule(); });
document.getElementById('game-name').addEventListener('input', () => { if (autosaveEnabled) autosaveSchedule(); });

document.getElementById('game-stats-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const gameDate = document.getElementById('game-date').value;

    // Inverted logic: unchecked => N/A (disabled), zero this stat on submit
    const na = {
        plus_minus: !(document.getElementById('na_plus_minus')?.checked ?? true)
    };

    const players = [];
    for (let i = 0; i < playerCount; i++) {
        players.push({
            player_id: parseInt(document.getElementById(`player_id_${i}`).value),
            plus_minus: na.plus_minus ? 0 : playerStats[i].plus_minus
        });
    }

    try {
        const response = await fetch('/save_game_stats', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_date: gameDate,
                game_name: (document.getElementById('game-name').value || '').trim(),
                players: players
            })
        });

        const result = await response.json();
        const alertContainer = document.getElementById('alert-container');

        if (result.success) {
            // Enable autosave from now on
            autosaveEnabled = true;
            setAutosaveStatus('Autosave enabled');

            // Show popup modal confirmation
            const modal = document.getElementById('save-modal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => { modal.style.display = 'none'; }, 1500);
            }

            // Optional: also show an inline alert for non-mobile
            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    Game saved. Autosave is now ON.
                    <a href="/" style="margin-left: 10px;">View Dashboard</a>
                </div>
            `;
            // Do not auto-reset stats here to avoid confirmation popup; user can use the Reset All button if desired.
        } else {
            alertContainer.innerHTML = `
                <div class="alert alert-error">
                    Error: ${result.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('alert-container').innerHTML = `
            <div class="alert alert-error">
                An error occurred while saving the stats.
            </div>
        `;
    }
});

// Prefill date and name from server-provided values if present; otherwise default date to now
{% if initial_game_date %}
document.getElementById('game-date').value = {{ initial_game_date|tojson }};
{% else %}
document.getElementById('game-date').value = new Date().toISOString().slice(0, 16);
{% endif %}
{% if initial_game_name %}
document.getElementById('game-name').value = {{ initial_game_name|tojson }};
{% endif %}

// Add keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Press 'r' to reset all stats
    if (e.key === 'r' && !e.target.matches('input')) {
        resetAllStats();
    }
});
</script>
{% endblock %}